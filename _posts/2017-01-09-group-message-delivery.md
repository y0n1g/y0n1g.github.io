---
title: 组消息传递
layout: post
category: [tech]
tags: [AWS,SQS, SNS]
---
{% include JB/setup %}
向一个组发送消息是一个很常见的服务. 典型的应用,比如一个微信群中所有的用户都属于这个群组. 所有的人都可以向这个群组发消息,同时也会接收消息,而大家接收消息的时间都不相同.  
  
如何处理这种情况呢?  

我认为基于群组创建消息队列比较好. 所有的消息,除了内容部分, 至少还需要一个sender_id和time.  根据业务需要还可以添加其他属性. 群组内所有的用户, 消息发送后, 消息就属于这个群组了. 同时,当然可以为sender保留撤销(recall)的操作.  由于用户不是一直在线,有可能会随时登出, 就需要为每个用户维护一个进度指针, 指向这个用户当前收到的群组中最新的消息位置. 根据不同的策略,可以为用户推送更新的数据. 

用这种方法实现,节约了存储成本,增加了用户的灵活性,可以更好地保证用户的体验.  


AWS的SNS是向多个订阅者基于推送(push)的实时(time-critical)消息服务,不需要查询(poll).
AWS的SQS是为分布式应用提供基于查询(poll)的消息队列服务.

对于非常小的数据包,同时实时性又不是那么高的情形, 上述计费方法就会比较贵.  因此这里可以提供这么一个web服务, 将用户的多个消息数据进行整合打包, 每64KB调用一次API.  
AWS的SQS的计费方法是按照API调用次数收费的. 同时最大支持的消息包是256KB, 计费的单个消息包大小是64KB, 因此对于256KB的情形,会计算4次费用.  


